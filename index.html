<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión 3D Pro - V6.1 Estable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid-stock { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 768px) { .grid-stock { grid-template-columns: repeat(4, 1fr); } }
        
        .img-stock-container { position: relative; width: 100%; aspect-ratio: 1/1; overflow: hidden; border-radius: 12px; background: #e2e8f0; }
        .img-stock-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-stock { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: flex-end; }
        @media (min-width: 768px) { .modal-stock { align-items: center; justify-content: center; } }
        .modal-stock-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 20px 20px 0 0; padding: 20px; }
        @media (min-width: 768px) { .modal-stock-content { max-width: 450px; border-radius: 20px; } }
        
        .preview-badge { font-size: 10px; font-weight: 800; color: #1e3a8a; background: #dbeafe; padding: 1px 5px; border-radius: 4px; }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-2">
            <h1 class="text-xl font-bold"><i class="fas fa-cube"></i> Gestión 3D</h1>
            <button onclick="exportarExcel()" class="bg-green-600 text-white text-xs py-1 px-3 rounded flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Backup
            </button>
        </div>
        <div class="container mx-auto flex justify-around mt-4 text-[10px] font-bold uppercase tracking-wider">
            <button onclick="switchTab('cotizador')" class="tab-btn pb-2 border-b-2 border-blue-400" id="btn-cotizador">Cotizar</button>
            <button onclick="switchTab('libro')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-libro">Ventas</button>
            <button onclick="switchTab('gastos')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-gastos">Insumos</button>
            <button onclick="switchTab('resumen')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-resumen">Finanzas</button>
            <button onclick="switchTab('stock')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-stock">Stock</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">
        <div id="cotizador" class="tab-content active max-w-xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4 text-sm font-bold uppercase text-gray-500">Calculadora <span id="costoRealRef" class="text-red-500">$0</span></div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="nombreTrabajo" class="col-span-2 border p-3 rounded-lg bg-gray-50" placeholder="Nombre del Trabajo" oninput="calcular()">
                    <input type="number" id="filamento" class="border p-3 rounded-lg" placeholder="Filamento (gr)" oninput="calcular()">
                    <input type="number" id="energia" class="border p-3 rounded-lg" placeholder="Energía (hs)" oninput="calcular()">
                    <div class="flex items-center gap-2 px-2"><input type="checkbox" id="checkLlavero" class="w-5 h-5" onchange="toggleLlavero()"><label class="text-xs font-bold">Llavero</label></div>
                    <div id="boxLlavero" class="hidden"><input type="number" id="cantLlaveros" class="w-full border p-3 rounded-lg" value="0" oninput="calcular()"></div>
                    <input type="number" id="manoObra" class="col-span-2 border p-3 rounded-lg" placeholder="Mano de Obra (horas)" oninput="calcular()">
                </div>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center border-t-8 border-blue-900">
                <p id="displayNombre" class="text-sm font-bold text-gray-400 uppercase mb-2">Proyecto</p>
                <h2 id="precioFinalDisplay" class="text-5xl font-black text-gray-900">$0</h2>
                <button onclick="abrirModalGuardar()" class="w-full mt-8 bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg">REGISTRAR VENTA</button>
            </div>
        </div>

        <div id="libro" class="tab-content max-w-xl mx-auto"><div id="listaVentasPorMes"></div></div>
        <div id="gastos" class="tab-content max-w-xl mx-auto"><div id="listaGastosItems"></div></div>
        <div id="resumen" class="tab-content max-w-xl mx-auto">
            <div class="bg-black text-white p-6 rounded-2xl mb-6 flex justify-between">
                <div><p class="text-[10px] text-gray-400">CAJA TEÓRICA</p><h2 id="balanceTotal" class="text-3xl font-bold text-green-400">$0</h2></div>
                <div class="text-right"><p class="text-[10px] text-gray-400">KUBO APP</p><input type="number" id="saldoKubo" class="bg-transparent border-b text-right w-20 outline-none" oninput="conciliarCaja()"><p id="diffKubo" class="text-[10px]"></p></div>
            </div>
            <div class="bg-white p-4 rounded-xl mb-4"><canvas id="canvasGrafico"></canvas></div>
        </div>

        <div id="stock" class="tab-content">
            <div class="bg-blue-900 text-white p-4 rounded-2xl mb-6 shadow-lg flex justify-between items-center">
                <div>
                    <p class="text-[10px] opacity-70 uppercase font-black">Total Stock Lámparas</p>
                    <h2 id="totalGlobalStock" class="text-3xl font-black">0</h2>
                </div>
                <button onclick="nuevoModelo()" class="bg-white text-blue-900 px-4 py-2 rounded-xl font-bold text-xs uppercase">+ Nuevo Modelo</button>
            </div>

            <div class="grid-stock mb-10" id="contenedorLamparas"></div>
            
            <h2 class="text-xs font-black uppercase text-gray-400 mb-4 tracking-widest">Bases y Maderas</h2>
            <div class="grid-stock" id="contenedorBases"></div>
        </div>
    </div>

    <div id="modalStockDetalle" class="modal-stock">
        <div class="modal-stock-content">
            <div class="flex justify-between items-center mb-6">
                <span id="modalTotalUnidades" class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full text-[10px] font-black">0 UNIDADES</span>
                <button onclick="cerrarModalStock()" class="text-gray-300"><i class="fas fa-times-circle text-2xl"></i></button>
            </div>
            
            <div class="flex flex-col items-center mb-6">
                <div class="w-40 h-40 rounded-3xl overflow-hidden shadow-2xl border-4 border-white mb-4 relative bg-gray-100">
                    <img id="modalStockImg" src="" class="w-full h-full object-cover">
                    <input type="file" id="fileInModal" class="hidden" onchange="subirImagenModal(event)">
                    <button onclick="document.getElementById('fileInModal').click()" class="absolute bottom-2 right-2 bg-blue-900 text-white p-2 rounded-full shadow-lg"><i class="fas fa-pencil-alt"></i></button>
                </div>
                <input type="text" id="modalStockNombre" class="text-center font-black text-xl w-full outline-none uppercase" placeholder="NOMBRE DEL MODELO" onblur="guardarNombreModelo(this.value)">
            </div>

            <div class="space-y-3" id="listaColoresStock"></div>
            
            <button onclick="agregarNuevoColor()" class="w-full mt-4 border-2 border-dashed border-gray-200 py-3 rounded-xl text-gray-400 font-bold text-xs uppercase hover:bg-gray-50">+ Añadir Color</button>
            
            <div class="flex gap-2 mt-8">
                <button onclick="eliminarModelo()" class="flex-1 text-red-400 text-[10px] font-bold uppercase">Eliminar Modelo</button>
                <button onclick="cerrarModalStock()" class="flex-[2] bg-blue-900 text-white py-4 rounded-2xl font-black uppercase shadow-xl">Guardar y Salir</button>
            </div>
        </div>
    </div>

    <div id="modalGuardar" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
            <h3 class="font-bold mb-4">Registrar Venta</h3>
            <input type="text" id="modalCliente" placeholder="Cliente" class="w-full border p-3 rounded-xl mb-4">
            <button onclick="guardarDesdeCotizador()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold">CONFIRMAR</button>
        </div>
    </div>

    <script>
        // PERSISTENCIA MEJORADA
        let ventas = JSON.parse(localStorage.getItem('ventas_3d_v3')) || [];
        let gastos = JSON.parse(localStorage.getItem('gastos_3d_v3')) || [];
        let stockLamparas = JSON.parse(localStorage.getItem('stock_lamparas_v6.1')) || [
            { id: 1, nombre: 'LÁMPARA EJEMPLO', img: '', colores: { 'BLANCO': 0, 'NEGRO': 0 } }
        ];
        let stockBases = JSON.parse(localStorage.getItem('stock_bases_3d')) || Array(3).fill().map((_, i) => ({ 
            id: i, nombre: `Base ${i+1}`, img: '', maderas: [{ nombre: 'Roble', stock: 0 }, { nombre: 'Negro', stock: 0 }] 
        }));

        let modeloActivoId = null;

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('border-blue-400'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('border-blue-400');
            if(id === 'stock') renderStock();
            if(id === 'resumen') renderResumen();
        }

        // --- SISTEMA DE STOCK V6.1 ---
        function renderStock() {
            const container = document.getElementById('contenedorLamparas');
            container.innerHTML = '';
            let globalTotal = 0;

            stockLamparas.forEach(mod => {
                let modelTotal = Object.values(mod.colores).reduce((a, b) => a + b, 0);
                globalTotal += modelTotal;

                container.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm flex flex-col items-center relative overflow-hidden" onclick="abrirModalStock(${mod.id})">
                        <div class="img-stock-container">
                            <img src="${mod.img || 'https://via.placeholder.com/150'}">
                        </div>
                        <div class="w-full mt-2">
                            <p class="font-black text-[10px] uppercase truncate text-gray-700">${mod.nombre}</p>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-[9px] text-gray-400 font-bold uppercase">${Object.keys(mod.colores).length} Colores</span>
                                <span class="preview-badge">${modelTotal} ud</span>
                            </div>
                        </div>
                    </div>`;
            });

            document.getElementById('totalGlobalStock').innerText = globalTotal;

            // Render Bases (Optimizado)
            const cb = document.getElementById('contenedorBases');
            cb.innerHTML = '';
            stockBases.forEach(b => {
                cb.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100">
                        <img src="${b.img || 'https://via.placeholder.com/100'}" class="w-full aspect-square object-cover rounded-xl mb-2" onclick="triggerBaseFile(${b.id})">
                        <input type="file" id="fb-${b.id}" class="hidden" onchange="subirImgBase(event, ${b.id})">
                        <div class="space-y-1">
                            ${b.maderas.map((m, i) => `
                                <div class="flex justify-between items-center text-[8px] bg-gray-50 p-1 rounded font-bold uppercase">
                                    <span>${m.nombre}</span>
                                    <div class="flex items-center gap-1">
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, -1)" class="w-4 h-4 bg-white border rounded">-</button>
                                        <span class="w-3 text-center">${m.stock}</span>
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, 1)" class="w-4 h-4 bg-white border rounded">+</button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>`;
            });
        }

        function abrirModalStock(id) {
            modeloActivoId = id;
            const mod = stockLamparas.find(m => m.id === id);
            document.getElementById('modalStockNombre').value = mod.nombre;
            document.getElementById('modalStockImg').src = mod.img || 'https://via.placeholder.com/150';
            renderColoresModal();
            document.getElementById('modalStockDetalle').style.display = 'flex';
        }

        function renderColoresModal() {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            const container = document.getElementById('listaColoresStock');
            container.innerHTML = '';
            let modelTotal = 0;

            Object.keys(mod.colores).forEach(color => {
                modelTotal += mod.colores[color];
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <span class="text-xs font-black text-blue-900 uppercase">${color}</span>
                        <div class="flex items-center gap-4">
                            <button onclick="cambiarStockColor('${color}', -1)" class="w-8 h-8 bg-white shadow rounded-full font-black">-</button>
                            <span class="text-lg font-black w-8 text-center">${mod.colores[color]}</span>
                            <button onclick="cambiarStockColor('${color}', 1)" class="w-8 h-8 bg-blue-900 text-white shadow rounded-full font-black">+</button>
                        </div>
                    </div>`;
            });
            document.getElementById('modalTotalUnidades').innerText = `${modelTotal} UNIDADES`;
        }

        function cambiarStockColor(color, delta) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.colores[color] = Math.max(0, mod.colores[color] + delta);
            saveStock();
            renderColoresModal();
        }

        function agregarNuevoColor() {
            const nombre = prompt("Nombre del color:").toUpperCase();
            if(nombre) {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                if(!mod.colores[nombre]) mod.colores[nombre] = 0;
                saveStock();
                renderColoresModal();
            }
        }

        function guardarNombreModelo(val) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.nombre = val.toUpperCase();
            saveStock();
        }

        function subirImagenModal(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                stockLamparas.find(m => m.id === modeloActivoId).img = ev.target.result;
                document.getElementById('modalStockImg').src = ev.target.result;
                saveStock();
            };
            r.readAsDataURL(f);
        }

        function saveStock() {
            localStorage.setItem('stock_lamparas_v6.1', JSON.stringify(stockLamparas));
        }

        function nuevoModelo() {
            const id = Date.now();
            stockLamparas.push({ id, nombre: 'NUEVO MODELO', img: '', colores: { 'BLANCO': 0 } });
            saveStock();
            renderStock();
            abrirModalStock(id);
        }

        function eliminarModelo() {
            if(confirm('¿ELIMINAR MODELO?')) {
                stockLamparas = stockLamparas.filter(m => m.id !== modeloActivoId);
                saveStock();
                cerrarModalStock();
            }
        }

        function cerrarModalStock() {
            document.getElementById('modalStockDetalle').style.display = 'none';
            renderStock();
        }

        // Lógica de Bases (Optimizado)
        function chStBase(bid, mid, d) {
            stockBases.find(x => x.id === bid).maderas[mid].stock = Math.max(0, stockBases.find(x => x.id === bid).maderas[mid].stock + d);
            localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases));
            renderStock();
        }
        function triggerBaseFile(id) { document.getElementById(`fb-${id}`).click(); }
        function subirImgBase(e, id) {
            const r = new FileReader();
            r.onload = (ev) => { stockBases.find(x => x.id === id).img = ev.target.result; localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases)); renderStock(); };
            r.readAsDataURL(e.target.files[0]);
        }

        // --- LÓGICA FINANCIERA PRESERVADA ---
        const config = { fil: 20, ene: 100, lla: 200 };
        let tempPrecio = 0, tempCostoMat = 0, miChart = null;

        function calcular() {
            const f = parseFloat(document.getElementById('filamento').value) || 0;
            const e = parseFloat(document.getElementById('energia').value) || 0;
            const l = document.getElementById('checkLlavero').checked ? (parseFloat(document.getElementById('cantLlaveros').value) || 0) : 0;
            const m = parseFloat(document.getElementById('manoObra').value) || 0;
            tempCostoMat = (f * config.fil) + (e * config.ene) + (l * config.lla);
            tempPrecio = Math.round(((f * config.fil + e * config.ene) * 3.5) + (l * config.lla) + (m * 10000)); 
            document.getElementById('costoRealRef').innerText = `$${tempCostoMat.toLocaleString()}`;
            document.getElementById('precioFinalDisplay').innerText = `$${tempPrecio.toLocaleString()}`;
            document.getElementById('displayNombre').innerText = document.getElementById('nombreTrabajo').value || "PROYECTO";
        }

        function abrirModalGuardar() { document.getElementById('modalGuardar').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalGuardar').classList.add('hidden'); }
        function guardarDesdeCotizador() {
            ventas.push({ id: Date.now(), fecha: new Date().toISOString().split('T')[0], cliente: document.getElementById('modalCliente').value || "S/N", trabajo: document.getElementById('nombreTrabajo').value || "Imp. 3D", precio: tempPrecio, costo: tempCostoMat, categoria: 'Lámparas' });
            localStorage.setItem('ventas_3d_v3', JSON.stringify(ventas));
            cerrarModal(); renderResumen();
        }

        function renderResumen() {
            const totalVentas = ventas.reduce((s,v) => s + v.precio, 0);
            const totalCostoProd = ventas.reduce((s,v) => s + v.costo, 0);
            const totalInsumos = gastos.reduce((s,g) => s + g.monto, 0);
            document.getElementById('balanceTotal').innerText = `$${(totalVentas - (totalCostoProd + totalInsumos)).toLocaleString()}`;
            
            const ctx = document.getElementById('canvasGrafico').getContext('2d');
            if(miChart) miChart.destroy();
            miChart = new Chart(ctx, { type: 'bar', data: { labels: ['Ventas', 'Insumos'], datasets: [{ data: [totalVentas, totalInsumos], backgroundColor: ['#1e3a8a', '#ef4444'] }] }});
        }

        function conciliarCaja() {
            const t = parseFloat(document.getElementById('balanceTotal').innerText.replace(/\$|\./g, '')) || 0;
            const k = parseFloat(document.getElementById('saldoKubo').value) || 0;
            document.getElementById('diffKubo').innerText = `Dif: $${(k - t).toLocaleString()}`;
        }

        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(ventas);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            XLSX.writeFile(wb, "Gestion_3D_Backup.xlsx");
        }

        function toggleLlavero() { document.getElementById('boxLlavero').classList.toggle('hidden', !document.getElementById('checkLlavero').checked); }

        // INIT
        renderStock(); renderResumen();
    </script>
</body>
</html>
