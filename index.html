<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión 3D Pro - V6 Stock Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .ticket-cliente { background: #ffffff; border: 1px solid #e2e8f0; border-top: 8px solid #1e3a8a; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kpi-card { background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; }
        
        /* Estilos Stock V6 */
        .grid-stock { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 768px) { .grid-stock { grid-template-columns: repeat(3, 1fr); } }
        
        .img-stock-container { position: relative; width: 100%; aspect-ratio: 1/1; overflow: hidden; border-radius: 12px; background: #e2e8f0; }
        .img-stock-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .img-stock-container img:active { transform: scale(1.1); }
        
        .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; }
        .preview-stock-badge { font-size: 9px; background: #f8fafc; padding: 2px 4px; border-radius: 4px; border: 1px solid #e2e8f0; }
        
        .modal-stock { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: flex-end; }
        @media (min-width: 768px) { .modal-stock { align-items: center; } }
        .modal-stock-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 20px 20px 0 0; padding: 20px; }
        @media (min-width: 768px) { .modal-stock-content { max-width: 500px; border-radius: 20px; margin: auto; } }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-2">
            <h1 class="text-xl font-bold"><i class="fas fa-microchip"></i> Gestión 3D</h1>
            <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Exportar
            </button>
        </div>
        <div class="container mx-auto flex justify-around mt-4 text-[10px] md:text-xs font-bold uppercase tracking-wider">
            <button onclick="switchTab('cotizador')" class="tab-btn pb-2 border-b-2 border-blue-400" id="btn-cotizador">Cotizar</button>
            <button onclick="switchTab('libro')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-libro">Ventas</button>
            <button onclick="switchTab('gastos')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-gastos">Insumos</button>
            <button onclick="switchTab('resumen')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-resumen">Finanzas</button>
            <button onclick="switchTab('stock')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-stock">Stock</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">

        <div id="cotizador" class="tab-content active max-w-xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-800 uppercase text-sm tracking-widest">Calculadora Interna</h2>
                    <div class="bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-100">Costo Mat: <span id="costoRealRef">$0</span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Nombre del Trabajo</label><input type="text" id="nombreTrabajo" class="w-full border p-2 rounded bg-gray-50 focus:bg-white outline-blue-500" placeholder="Ej: Lámpara Saturno" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Filamento (gr)</label><input type="number" id="filamento" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Energía (horas)</label><input type="number" id="energia" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="checkLlavero" class="w-5 h-5 rounded" onchange="toggleLlavero()"><label class="text-xs font-bold text-gray-700">¿Llavero?</label></div>
                    <div id="boxLlavero" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">Cant. Llaveros</label><input type="number" id="cantLlaveros" class="w-full border p-2 rounded" value="0" oninput="calcular()"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Mano de Obra (horas)</label><input type="number" id="manoObra" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                </div>
            </div>
            <div class="ticket-cliente p-8 text-center" id="ticketVisual">
                <div class="text-blue-900 font-black text-xs uppercase tracking-[0.3em] mb-4 italic">Presupuesto de Impresión 3D</div>
                <h3 id="displayNombre" class="text-xl font-bold text-gray-800 mb-2">Proyecto Personalizado</h3>
                <div class="h-1 w-12 bg-blue-900 mx-auto mb-6"></div>
                <div class="text-5xl font-black text-gray-900 mb-2" id="precioFinalDisplay">$0</div>
                <p class="text-gray-400 text-[10px] uppercase mb-6 tracking-widest">Impuestos e insumos incluidos</p>
            </div>
            <button onclick="abrirModalGuardar()" class="w-full mt-6 bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition-all flex items-center justify-center gap-3"><i class="fas fa-save"></i> REGISTRAR VENTA</button>
        </div>

        <div id="libro" class="tab-content max-w-xl mx-auto">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h2 class="font-bold text-gray-700 mb-3">Carga Manual</h2>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <input type="text" id="ventaCliente" placeholder="Cliente" class="border p-2 rounded">
                    <input type="date" id="ventaFecha" class="border p-2 rounded">
                    <input type="number" id="ventaPrecio" placeholder="Precio Venta" class="border p-2 rounded">
                    <input type="number" id="ventaCosto" placeholder="Costo Material" class="border p-2 rounded">
                    <select id="ventaCategoria" class="border p-2 rounded col-span-2"><option value="Lámparas">Lámparas</option><option value="Llaveros">Llaveros</option><option value="Impresión particular">Impresión particular</option></select>
                    <button onclick="agregarVentaManual()" class="col-span-2 bg-blue-600 text-white py-2 rounded font-bold uppercase tracking-widest">Añadir al Libro</button>
                </div>
            </div>
            <div id="listaVentasPorMes" class="space-y-4 text-sm"></div>
        </div>

        <div id="gastos" class="tab-content max-w-xl mx-auto">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-red-500">
                <h2 class="font-bold text-gray-700 mb-2 italic">Compra de Insumos</h2>
                <div class="space-y-2">
                    <input type="text" id="gastoMotivo" placeholder="Ej: Bobina PLA" class="w-full border p-2 rounded text-sm">
                    <div class="flex gap-2"><input type="number" id="gastoMonto" placeholder="Monto $" class="w-full border p-2 rounded text-sm"><input type="date" id="gastoFecha" class="border p-2 rounded text-sm"></div>
                    <button onclick="agregarGasto()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold">REGISTRAR GASTO</button>
                </div>
            </div>
            <div id="listaGastosItems" class="bg-white rounded-xl shadow-sm overflow-hidden divide-y"></div>
        </div>

        <div id="resumen" class="tab-content max-w-xl mx-auto">
            <div class="bg-black text-white p-5 rounded-2xl shadow-xl mb-6 relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="text-[10px] uppercase tracking-widest text-gray-400">Balance Teórico (Caja)</div>
                        <div id="balanceTotal" class="text-3xl font-black text-green-400">$0</div>
                    </div>
                    <div class="text-right">
                        <label class="text-[10px] uppercase tracking-widest text-gray-400 block mb-1">Saldo Kubo App</label>
                        <input type="number" id="saldoKubo" class="bg-white/10 border border-white/20 rounded px-2 py-1 text-right text-sm font-bold w-24 outline-none focus:border-green-400" oninput="conciliarCaja()">
                        <div id="diffKubo" class="text-[10px] mt-1 font-bold">Dif: $0</div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <select id="filtroMes" class="flex-1 border p-2 rounded-lg text-sm bg-white" onchange="renderResumen()">
                    <option value="all">HISTÓRICO COMPLETO</option>
                </select>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6"><canvas id="canvasGrafico"></canvas></div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="kpi-card text-center"><div class="text-[9px] font-bold text-blue-500 uppercase">Ventas Brutas</div><div id="kpiVentas" class="text-lg font-black">$0</div></div>
                <div class="kpi-card text-center"><div class="text-[9px] font-bold text-green-600 uppercase">Rentabilidad</div><div id="kpiRentabilidad" class="text-lg font-black">0%</div></div>
                <div class="kpi-card text-center"><div class="text-[9px] font-bold text-purple-500 uppercase">Ticket Prom.</div><div id="kpiTicket" class="text-lg font-black">$0</div></div>
                <div class="kpi-card text-center"><div class="text-[9px] font-bold text-orange-500 uppercase">Ganancia Prom.</div><div id="kpiGananciaProm" class="text-lg font-black">$0</div></div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3 text-sm border border-gray-100">
                <div class="flex justify-between"><span>Ventas (Facturación)</span><span id="detIngresos" class="text-blue-600 font-bold">$0</span></div>
                <div class="flex justify-between border-b pb-2"><span>Costos Prod. Vendida</span><span id="detCostosProd" class="text-red-500">-$0</span></div>
                <div class="flex justify-between pt-1 font-black text-lg"><span>GANANCIA BRUTA</span><span id="detNeto" class="text-green-600">$0</span></div>
                <div class="flex justify-between pt-4 text-gray-400 border-t"><span>Inversión en Insumos</span><span id="detGastosIns" class="font-bold">$0</span></div>
            </div>
        </div>

        <div id="stock" class="tab-content">
            <button onclick="nuevoModelo()" class="w-full bg-blue-900 text-white py-3 rounded-xl font-bold mb-6 flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> NUEVO MODELO DE LÁMPARA
            </button>

            <section class="mb-8">
                <h2 class="text-lg font-black uppercase text-gray-800 mb-4 border-l-4 border-yellow-500 pl-3">Catálogo de Lámparas</h2>
                <div class="grid-stock" id="contenedorLamparas"></div>
            </section>

            <section>
                <h2 class="text-lg font-black uppercase text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">Stock de Bases</h2>
                <div class="grid-stock" id="contenedorBases"></div>
            </section>
        </div>

    </div>

    <div id="modalGuardar" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center">
            <h3 class="font-bold text-lg mb-4 text-blue-900">Finalizar Venta</h3>
            <input type="text" id="modalCliente" placeholder="Nombre del Cliente" class="w-full border p-3 rounded-xl mb-4">
            <select id="modalCategoria" class="w-full border p-3 rounded-xl mb-4"><option value="Lámparas">Lámparas</option><option value="Llaveros">Llaveros</option><option value="Impresión particular">Impresión particular</option></select>
            <div class="flex gap-2"><button onclick="cerrarModal()" class="flex-1 bg-gray-100 py-3 rounded-xl">VOLVER</button><button onclick="guardarDesdeCotizador()" class="flex-1 bg-blue-900 text-white py-3 rounded-xl">CONFIRMAR</button></div>
        </div>
    </div>

    <div id="modalStockDetalle" class="modal-stock">
        <div class="modal-stock-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-blue-900 uppercase">Gestionar Modelo</h3>
                <button onclick="cerrarModalStock()" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex flex-col items-center gap-4 mb-6">
                <div class="w-32 h-32 rounded-2xl overflow-hidden border-4 border-blue-100 relative">
                    <img id="modalStockImg" src="" class="w-full h-full object-cover">
                    <button onclick="document.getElementById('fileInModal').click()" class="absolute inset-0 bg-black/40 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                        <i class="fas fa-camera"></i>
                    </button>
                    <input type="file" id="fileInModal" class="hidden" onchange="subirImagenModal(event)">
                </div>
                <input type="text" id="modalStockNombre" class="text-center font-bold text-xl border-b border-gray-200 outline-none focus:border-blue-900" onblur="guardarNombreModelo(this.value)">
            </div>

            <div class="bg-gray-50 p-4 rounded-xl">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-gray-500 uppercase">Variantes de Color</span>
                    <button onclick="agregarNuevoColor()" class="text-[10px] bg-blue-900 text-white px-2 py-1 rounded-full">+ Agregar Color</button>
                </div>
                <div id="listaColoresStock" class="space-y-3">
                    </div>
            </div>
            <button onclick="cerrarModalStock()" class="w-full bg-blue-900 text-white py-4 rounded-xl mt-6 font-bold uppercase">Guardar Cambios</button>
            <button onclick="eliminarModelo()" class="w-full text-red-500 text-xs mt-4 uppercase font-bold">Eliminar Modelo Completamente</button>
        </div>
    </div>

    <script>
        // DATOS INICIALES
        let ventas = JSON.parse(localStorage.getItem('ventas_3d_v3')) || [];
        let gastos = JSON.parse(localStorage.getItem('gastos_3d_v3')) || [];
        let saldoKuboGuardado = localStorage.getItem('saldo_kubo_conciliacion') || 0;
        
        let stockLamparas = JSON.parse(localStorage.getItem('stock_lamparas_v6')) || [
            { id: 1, nombre: 'Modelo 1', img: '', colores: { 'BLANCO': 0, 'NEGRO': 0, 'AQUA': 0 } }
        ];

        let stockBases = JSON.parse(localStorage.getItem('stock_bases_3d')) || Array(3).fill().map((_, i) => ({ 
            id: i, nombre: `Base Tipo ${i+1}`, img: '', maderas: [{ nombre: 'Roble', stock: 0 }, { nombre: 'Pino', stock: 0 }, { nombre: 'Negro', stock: 0 }] 
        }));

        let modeloActivoId = null;
        const config = { fil: 20, ene: 100, lla: 200 }; 
        let tempPrecio = 0, tempCostoMat = 0, miChart = null;

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('border-blue-400'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('border-blue-400');
            if(id === 'resumen') renderResumen();
            if(id === 'stock') renderStock();
            if(id === 'libro') renderLibro();
            if(id === 'gastos') renderGastos();
        }

        // STOCK LÁMPARAS V6
        function renderStock() {
            const container = document.getElementById('contenedorLamparas');
            container.innerHTML = '';
            stockLamparas.forEach(mod => {
                let colorPreview = '';
                Object.keys(mod.colores).slice(0, 4).forEach(c => {
                    colorPreview += `<div class="flex flex-col items-center">
                        <div class="preview-stock-badge">${mod.colores[c]}</div>
                        <div class="text-[7px] text-gray-400">${c.substring(0,3)}</div>
                    </div>`;
                });

                container.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center" onclick="abrirModalStock(${mod.id})">
                        <div class="img-stock-container">
                            <img src="${mod.img || 'https://via.placeholder.com/150'}">
                        </div>
                        <div class="font-bold text-[11px] mt-2 uppercase text-gray-700 truncate w-full text-center">${mod.nombre}</div>
                        <div class="flex gap-2 mt-2 w-full justify-center">
                            ${colorPreview}
                            ${Object.keys(mod.colores).length > 4 ? '<div class="text-[8px] text-gray-300 self-end">...</div>' : ''}
                        </div>
                    </div>`;
            });

            // Bases (Grilla compacta también)
            const cb = document.getElementById('contenedorBases');
            cb.innerHTML = '';
            stockBases.forEach(b => {
                cb.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100">
                        <div class="img-stock-container">
                            <img src="${b.img || 'https://via.placeholder.com/150'}" onclick="triggerBaseFile(${b.id})">
                            <input type="file" id="fb-${b.id}" class="hidden" onchange="subirImgBase(event, ${b.id})">
                        </div>
                        <div class="font-bold text-[10px] mt-2 text-center uppercase">${b.nombre}</div>
                        <div class="mt-2 space-y-1">
                            ${b.maderas.map((m, i) => `
                                <div class="flex justify-between items-center text-[9px] bg-gray-50 p-1 rounded">
                                    <span class="font-bold">${m.nombre}</span>
                                    <div class="flex items-center gap-2">
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, -1)" class="w-5 h-5 bg-white border rounded">-</button>
                                        <span class="w-3 text-center">${m.stock}</span>
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, 1)" class="w-5 h-5 bg-white border rounded">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            });
        }

        function abrirModalStock(id) {
            modeloActivoId = id;
            const mod = stockLamparas.find(m => m.id === id);
            document.getElementById('modalStockNombre').value = mod.nombre;
            document.getElementById('modalStockImg').src = mod.img || 'https://via.placeholder.com/150';
            renderColoresModal();
            document.getElementById('modalStockDetalle').style.display = 'flex';
        }

        function renderColoresModal() {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            const container = document.getElementById('listaColoresStock');
            container.innerHTML = '';
            Object.keys(mod.colores).forEach(color => {
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100">
                        <span class="text-sm font-black text-gray-600">${color}</span>
                        <div class="flex items-center gap-4">
                            <button onclick="cambiarStockColor('${color}', -1)" class="w-8 h-8 bg-gray-100 rounded-full font-bold">-</button>
                            <span class="text-lg font-black w-6 text-center">${mod.colores[color]}</span>
                            <button onclick="cambiarStockColor('${color}', 1)" class="w-8 h-8 bg-blue-900 text-white rounded-full font-bold">+</button>
                            <button onclick="borrarColor('${color}')" class="text-red-200 ml-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        function cambiarStockColor(color, delta) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.colores[color] = Math.max(0, mod.colores[color] + delta);
            saveStock();
            renderColoresModal();
        }

        function agregarNuevoColor() {
            const nombre = prompt("Nombre del nuevo color (ej: COBRE, LILA):");
            if(nombre) {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                const upper = nombre.toUpperCase();
                if(!mod.colores[upper]) mod.colores[upper] = 0;
                saveStock();
                renderColoresModal();
            }
        }

        function borrarColor(color) {
            if(confirm('¿Eliminar variante?')) {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                delete mod.colores[color];
                saveStock();
                renderColoresModal();
            }
        }

        function guardarNombreModelo(nuevoNombre) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.nombre = nuevoNombre;
            saveStock();
        }

        function subirImagenModal(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                mod.img = ev.target.result;
                document.getElementById('modalStockImg').src = ev.target.result;
                saveStock();
            };
            reader.readAsDataURL(file);
        }

        function nuevoModelo() {
            const id = Date.now();
            stockLamparas.push({ id, nombre: 'NUEVO MODELO', img: '', colores: { 'BLANCO': 0 } });
            saveStock();
            renderStock();
            abrirModalStock(id);
        }

        function eliminarModelo() {
            if(confirm('¿BORRAR TODO EL MODELO? Se perderá el stock.')) {
                stockLamparas = stockLamparas.filter(m => m.id !== modeloActivoId);
                saveStock();
                cerrarModalStock();
            }
        }

        function cerrarModalStock() {
            document.getElementById('modalStockDetalle').style.display = 'none';
            renderStock();
        }

        function chStBase(bid, mid, delta) {
            const b = stockBases.find(x => x.id === bid);
            b.maderas[mid].stock = Math.max(0, b.maderas[mid].stock + delta);
            localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases));
            renderStock();
        }

        function triggerBaseFile(id) { document.getElementById(`fb-${id}`).click(); }
        function subirImgBase(e, id) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                stockBases.find(x => x.id === id).img = ev.target.result;
                localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases));
                renderStock();
            };
            r.readAsDataURL(f);
        }

        // --- LÓGICA DE VENTAS Y FINANZAS (CONSERVADA DE V5) ---
        function calcular() {
            const f = parseFloat(document.getElementById('filamento').value) || 0;
            const e = parseFloat(document.getElementById('energia').value) || 0;
            const l = document.getElementById('checkLlavero').checked ? (parseFloat(document.getElementById('cantLlaveros').value) || 0) : 0;
            const m = parseFloat(document.getElementById('manoObra').value) || 0;
            tempCostoMat = (f * config.fil) + (e * config.ene) + (l * config.lla);
            tempPrecio = Math.round(((f * config.fil + e * config.ene) * 3.5) + (l * config.lla) + (m * 10000)); 
            document.getElementById('costoRealRef').innerText = `$${tempCostoMat.toLocaleString()}`;
            document.getElementById('precioFinalDisplay').innerText = `$${tempPrecio.toLocaleString()}`;
            document.getElementById('displayNombre').innerText = document.getElementById('nombreTrabajo').value || "Proyecto Personalizado";
        }

        function renderResumen() {
            const f = document.getElementById('filtroMes').value;
            const vF = f === 'all' ? ventas : ventas.filter(v => v.fecha.startsWith(f));
            const gF = f === 'all' ? gastos : gastos.filter(g => g.fecha.startsWith(f));

            const totalVentas = vF.reduce((s,v) => s + v.precio, 0);
            const totalCostoProd = vF.reduce((s,v) => s + v.costo, 0);
            const gananciaBruta = totalVentas - totalCostoProd;
            const totalInsumos = gF.reduce((s,g) => s + g.monto, 0);

            document.getElementById('kpiVentas').innerText = `$${totalVentas.toLocaleString()}`;
            document.getElementById('kpiRentabilidad').innerText = totalVentas > 0 ? Math.round((gananciaBruta / totalVentas) * 100) + "%" : "0%";
            document.getElementById('kpiTicket').innerText = vF.length > 0 ? `$${Math.round(totalVentas / vF.length).toLocaleString()}` : "$0";
            document.getElementById('kpiGananciaProm').innerText = vF.length > 0 ? `$${Math.round(gananciaBruta / vF.length).toLocaleString()}` : "$0";

            document.getElementById('detIngresos').innerText = `$${totalVentas.toLocaleString()}`;
            document.getElementById('detCostosProd').innerText = `-$${totalCostoProd.toLocaleString()}`;
            document.getElementById('detNeto').innerText = `$${gananciaBruta.toLocaleString()}`;
            document.getElementById('detGastosIns').innerText = `$${totalInsumos.toLocaleString()}`;

            const totalHistV = ventas.reduce((s,v) => s + v.precio, 0);
            const totalHistE = ventas.reduce((s,v) => s + v.costo, 0) + gastos.reduce((s,g) => s + g.monto, 0);
            const balanceRealTeorico = totalHistV - totalHistE;
            document.getElementById('balanceTotal').innerText = `$${balanceRealTeorico.toLocaleString()}`;
            document.getElementById('saldoKubo').value = saldoKuboGuardado;
            conciliarCaja();

            // Gráfico
            const ctx = document.getElementById('canvasGrafico').getContext('2d');
            if(miChart) miChart.destroy();
            miChart = new Chart(ctx, { type: 'bar', data: { labels: ['Ingresos', 'Costos Mat.', 'Insumos'], datasets: [{ label: 'Finanzas', data: [totalVentas, totalCostoProd, totalInsumos], backgroundColor: ['#1e3a8a', '#f97316', '#ef4444'] }] }});
        }

        function conciliarCaja() {
            const teorico = parseFloat(document.getElementById('balanceTotal').innerText.replace(/\$|\./g, '').replace(',', '.')) || 0;
            const kubo = parseFloat(document.getElementById('saldoKubo').value) || 0;
            const diff = kubo - teorico;
            const el = document.getElementById('diffKubo');
            el.innerText = `Dif: ${diff >= 0 ? '+' : ''}$${diff.toLocaleString()}`;
            el.className = `text-[10px] mt-1 font-bold ${diff === 0 ? 'text-green-400' : 'text-red-400'}`;
            localStorage.setItem('saldo_kubo_conciliacion', kubo);
            saldoKuboGuardado = kubo;
        }

        function saveStock() { localStorage.setItem('stock_lamparas_v6', JSON.stringify(stockLamparas)); }
        function save() { localStorage.setItem('ventas_3d_v3', JSON.stringify(ventas)); localStorage.setItem('gastos_3d_v3', JSON.stringify(gastos)); }
        function abrirModalGuardar() { document.getElementById('modalGuardar').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalGuardar').classList.add('hidden'); }
        function toggleLlavero() { document.getElementById('boxLlavero').classList.toggle('hidden', !document.getElementById('checkLlavero').checked); calcular(); }

        function guardarDesdeCotizador() {
            const item = { id: Date.now(), fecha: new Date().toISOString().split('T')[0], cliente: document.getElementById('modalCliente').value || "S/N", trabajo: document.getElementById('nombreTrabajo').value || "Impresión 3D", precio: tempPrecio, costo: tempCostoMat, categoria: document.getElementById('modalCategoria').value };
            ventas.push(item); save(); cerrarModal(); alert("Venta registrada");
        }

        function agregarVentaManual() {
            const v = { id: Date.now(), fecha: document.getElementById('ventaFecha').value || new Date().toISOString().split('T')[0], cliente: document.getElementById('ventaCliente').value || "Manual", trabajo: "Carga manual", precio: parseFloat(document.getElementById('ventaPrecio').value) || 0, costo: parseFloat(document.getElementById('ventaCosto').value) || 0, categoria: document.getElementById('ventaCategoria').value };
            ventas.push(v); save(); renderLibro();
        }

        function agregarGasto() {
            const g = { id: Date.now(), fecha: document.getElementById('gastoFecha').value || new Date().toISOString().split('T')[0], motivo: document.getElementById('gastoMotivo').value || "Insumo", monto: parseFloat(document.getElementById('gastoMonto').value) || 0 };
            gastos.push(g); save(); renderGastos();
        }

        function renderLibro() {
            const container = document.getElementById('listaVentasPorMes'); container.innerHTML = '';
            const grupos = ventas.reduce((acc, v) => { const mes = v.fecha.substring(0, 7); if(!acc[mes]) acc[mes] = []; acc[mes].push(v); return acc; }, {});
            Object.keys(grupos).sort().reverse().forEach(mes => {
                let html = `<div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6"><div class="bg-gray-800 text-white px-4 py-2 text-xs font-bold uppercase tracking-widest">${mes}</div><table class="w-full text-left"><tbody class="divide-y divide-gray-100">`;
                grupos[mes].forEach(v => { html += `<tr class="p-3"><td class="p-3"><div class="font-bold">${v.cliente}</div><div class="text-[10px] text-gray-400">${v.trabajo}</div></td><td class="p-3 text-right"><div class="text-blue-600 font-bold">$${v.precio.toLocaleString()}</div><div class="text-[10px] text-green-500">+$${(v.precio - v.costo).toLocaleString()}</div></td><td class="p-3 text-center"><button onclick="borrarVenta(${v.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>`; });
                container.innerHTML += html + `</tbody></table></div>`;
            });
        }

        function renderGastos() {
            const div = document.getElementById('listaGastosItems'); div.innerHTML = '';
            gastos.slice().reverse().forEach(g => { div.innerHTML += `<div class="p-4 flex justify-between items-center bg-white"><div><div class="font-bold text-gray-700">${g.motivo}</div><div class="text-[10px] text-gray-400">${g.fecha}</div></div><div class="flex items-center gap-4"><span class="text-red-500 font-bold">-$${g.monto.toLocaleString()}</span><button onclick="borrarGasto(${g.id})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></button></div></div>`; });
        }

        function exportarExcel() {
            const data = ventas.map(v => ({ Fecha: v.fecha, Cliente: v.cliente, Detalle: v.trabajo, Categoria: v.categoria, Ingreso: v.precio, Costo_Material: v.costo, Ganancia_Bruta: v.precio - v.costo }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ventas"); XLSX.writeFile(wb, "Gestion_3D_Backup.xlsx");
        }

        // Init
        document.getElementById('ventaFecha').valueAsDate = new Date();
        document.getElementById('gastoFecha').valueAsDate = new Date();
        renderLibro(); renderGastos(); renderResumen(); renderStock();
    </script>
</body>
</html>
