<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión 3D Pro - V6.1 Conciliación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .ticket-cliente { background: #ffffff; border: 1px solid #e2e8f0; border-top: 8px solid #1e3a8a; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kpi-card { background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; }
        
        /* Estilos Stock V6 */
        .grid-stock { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        @media (min-width: 768px) { .grid-stock { grid-template-columns: repeat(3, 1fr); } }
        .img-stock-container { position: relative; width: 100%; aspect-ratio: 1/1; overflow: hidden; border-radius: 12px; background: #e2e8f0; }
        .img-stock-container img { width: 100%; height: 100%; object-fit: cover; }
        .editable-name { border-bottom: 1px dashed #cbd5e1; cursor: pointer; }
        .modal-stock { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
        @media (min-width: 768px) { .modal-stock { align-items: center; } }
        .modal-stock-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 20px 20px 0 0; padding: 20px; max-width: 450px; }
        @media (min-width: 768px) { .modal-stock-content { border-radius: 20px; } }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-2">
            <h1 class="text-xl font-bold"><i class="fas fa-microchip"></i> Gestión 3D</h1>
            <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Exportar
            </button>
        </div>
        <div class="container mx-auto flex justify-around mt-4 text-[10px] md:text-xs font-bold uppercase tracking-wider">
            <button onclick="switchTab('cotizador')" class="tab-btn pb-2 border-b-2 border-blue-400" id="btn-cotizador">Cotizar</button>
            <button onclick="switchTab('libro')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-libro">Ventas</button>
            <button onclick="switchTab('gastos')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-gastos">Insumos</button>
            <button onclick="switchTab('resumen')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-resumen">Finanzas</button>
            <button onclick="switchTab('stock')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-stock">Stock</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">

        <div id="cotizador" class="tab-content active max-w-xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-800 uppercase text-sm tracking-widest">Calculadora Interna</h2>
                    <div class="bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-100">Costo Mat: <span id="costoRealRef">$0</span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Nombre del Trabajo</label><input type="text" id="nombreTrabajo" class="w-full border p-2 rounded bg-gray-50 focus:bg-white outline-blue-500" placeholder="Ej: Lámpara Saturno" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Filamento (gr)</label><input type="number" id="filamento" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Energía (horas)</label><input type="number" id="energia" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="checkLlavero" class="w-5 h-5 rounded" onchange="toggleLlavero()"><label class="text-xs font-bold text-gray-700">¿Llavero?</label></div>
                    <div id="boxLlavero" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">Cant. Llaveros</label><input type="number" id="cantLlaveros" class="w-full border p-2 rounded" value="0" oninput="calcular()"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Mano de Obra (horas)</label><input type="number" id="manoObra" class="w-full border p-2 rounded" placeholder="0" oninput="calcular()"></div>
                </div>
            </div>
            <div class="ticket-cliente p-8 text-center" id="ticketVisual">
                <div class="text-blue-900 font-black text-xs uppercase tracking-[0.3em] mb-4 italic">Presupuesto de Impresión 3D</div>
                <h3 id="displayNombre" class="text-xl font-bold text-gray-800 mb-2">Proyecto Personalizado</h3>
                <div class="h-1 w-12 bg-blue-900 mx-auto mb-6"></div>
                <div class="text-5xl font-black text-gray-900 mb-2" id="precioFinalDisplay">$0</div>
                <p class="text-gray-400 text-[10px] uppercase mb-6 tracking-widest">Impuestos y materiales incluidos</p>
            </div>
            <button onclick="abrirModalGuardar()" class="w-full mt-6 bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition-all flex items-center justify-center gap-3"><i class="fas fa-save"></i> REGISTRAR VENTA</button>
        </div>

        <div id="libro" class="tab-content max-w-xl mx-auto">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h2 class="font-bold text-gray-700 mb-3">Carga Manual</h2>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <input type="text" id="ventaCliente" placeholder="Cliente" class="border p-2 rounded">
                    <input type="date" id="ventaFecha" class="border p-2 rounded">
                    <input type="number" id="ventaPrecio" placeholder="Precio Venta" class="border p-2 rounded">
                    <input type="number" id="ventaCosto" placeholder="Costo Material" class="border p-2 rounded">
                    <select id="ventaCategoria" class="border p-2 rounded col-span-2"><option value="Lámparas">Lámparas</option><option value="Llaveros">Llaveros</option><option value="Impresión particular">Impresión particular</option></select>
                    <button onclick="agregarVentaManual()" class="col-span-2 bg-blue-600 text-white py-2 rounded font-bold uppercase tracking-widest">Añadir al Libro</button>
                </div>
            </div>
            <div id="listaVentasPorMes" class="space-y-4 text-sm"></div>
        </div>

        <div id="gastos" class="tab-content max-w-xl mx-auto">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-red-500">
                <h2 class="font-bold text-gray-700 mb-2 italic">Compra de Insumos</h2>
                <div class="space-y-2">
                    <input type="text" id="gastoMotivo" placeholder="Ej: Bobina PLA" class="w-full border p-2 rounded text-sm">
                    <div class="flex gap-2"><input type="number" id="gastoMonto" placeholder="Monto $" class="w-full border p-2 rounded text-sm"><input type="date" id="gastoFecha" class="border p-2 rounded text-sm"></div>
                    <button onclick="agregarGasto()" class="w-full bg-red-500 text-white py-2 rounded-lg font-bold">REGISTRAR GASTO</button>
                </div>
            </div>
            <div id="listaGastosItems" class="bg-white rounded-xl shadow-sm overflow-hidden divide-y"></div>
        </div>

        <div id="resumen" class="tab-content max-w-xl mx-auto">
            <div class="bg-black text-white p-5 rounded-2xl shadow-xl mb-6 relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="text-[10px] uppercase tracking-widest text-gray-400">Balance Teórico (Caja)</div>
                        <div id="balanceTotal" class="text-3xl font-black text-green-400">$0</div>
                    </div>
                    <div class="text-right">
                        <label class="text-[10px] uppercase tracking-widest text-gray-400 block mb-1">Saldo en Kubo App</label>
                        <input type="number" id="saldoKubo" class="bg-white/10 border border-white/20 rounded px-2 py-1 text-right text-sm font-bold w-24 outline-none focus:border-green-400" placeholder="$0" oninput="conciliarCaja()">
                        <div id="diffKubo" class="text-[10px] mt-1 font-bold">Dif: $0</div>
                    </div>
                </div>
                <i class="fas fa-wallet text-6xl absolute -bottom-2 -left-2 opacity-10"></i>
            </div>

            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <select id="filtroMes" class="border p-2 rounded-lg text-sm bg-white" onchange="renderResumen()">
                    <option value="all">HISTÓRICO COMPLETO</option>
                </select>
                <select id="tipoGrafico" class="border p-2 rounded-lg text-sm bg-white" onchange="renderResumen()"><option value="torta">Ganancia x Categoría</option><option value="barras">Ingresos vs Insumos</option></select>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6"><canvas id="canvasGrafico"></canvas></div>
            <div class="grid grid-cols-2 gap-3 mb-6 text-center">
                <div class="kpi-card"><div class="text-[9px] font-bold text-blue-500 uppercase">Ventas Brutas</div><div id="kpiVentas" class="text-lg font-black text-gray-800">$0</div></div>
                <div class="kpi-card"><div class="text-[9px] font-bold text-green-600 uppercase">Rentabilidad s/Vta</div><div id="kpiRentabilidad" class="text-lg font-black text-gray-800">0%</div></div>
                <div class="kpi-card"><div class="text-[9px] font-bold text-purple-500 uppercase">Ticket Promedio</div><div id="kpiTicket" class="text-lg font-black text-gray-800">$0</div></div>
                <div class="kpi-card"><div class="text-[9px] font-bold text-orange-500 uppercase">Ganancia Promedio</div><div id="kpiGananciaProm" class="text-lg font-black text-gray-800">$0</div></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3 text-sm border border-gray-100">
                <div class="flex justify-between"><span>Ventas Brutas (Facturación)</span><span id="detIngresos" class="text-blue-600 font-bold">$0</span></div>
                <div class="flex justify-between border-b pb-2"><span>Costo Materiales Usados</span><span id="detCostosProd" class="text-red-500 font-medium">-$0</span></div>
                <div class="flex justify-between pt-1 font-black text-lg"><span>GANANCIA BRUTA</span><span id="detNeto" class="text-green-600">$0</span></div>
                <div class="flex justify-between pt-4 text-gray-400 border-t"><span>Inversión en Insumos (Stock)</span><span id="detGastosIns" class="font-bold">$0</span></div>
            </div>
        </div>

        <div id="stock" class="tab-content">
            <div class="bg-blue-900 text-white p-4 rounded-2xl mb-6 shadow-lg flex justify-between items-center">
                <div>
                    <p class="text-[10px] opacity-70 uppercase font-black tracking-widest">Total Stock Lámparas</p>
                    <h2 id="totalGlobalStock" class="text-3xl font-black">0</h2>
                </div>
                <button onclick="nuevoModelo()" class="bg-white text-blue-900 px-4 py-2 rounded-xl font-bold text-xs">+ NUEVO MODELO</button>
            </div>

            <section class="mb-8">
                <h2 class="text-xs font-black uppercase text-gray-400 mb-4 tracking-widest">Modelos</h2>
                <div class="grid-stock" id="contenedorLamparas"></div>
            </section>

            <section>
                <h2 class="text-xs font-black uppercase text-gray-400 mb-4 tracking-widest">Bases y Maderas</h2>
                <div class="grid-stock" id="contenedorBases"></div>
            </section>
        </div>
    </div>

    <div id="modalGuardar" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4 text-blue-900">Finalizar Venta</h3>
            <input type="text" id="modalCliente" placeholder="Nombre del Cliente" class="w-full border p-3 rounded-xl mb-2">
            <select id="modalCategoria" class="w-full border p-3 rounded-xl mb-4"><option value="Lámparas">Lámparas</option><option value="Llaveros">Llaveros</option><option value="Impresión particular">Impresión particular</option></select>
            <div class="flex gap-2 font-bold"><button onclick="cerrarModal()" class="flex-1 bg-gray-100 py-3 rounded-xl">VOLVER</button><button onclick="guardarDesdeCotizador()" class="flex-1 bg-blue-900 text-white py-3 rounded-xl">CONFIRMAR</button></div>
        </div>
    </div>

    <div id="modalStockDetalle" class="modal-stock">
        <div class="modal-stock-content">
            <div class="flex justify-between items-center mb-6">
                <span id="modalTotalUnidades" class="bg-blue-100 text-blue-900 px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">0 Unidades</span>
                <button onclick="cerrarModalStock()" class="text-gray-400 text-2xl"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="flex flex-col items-center mb-6">
                <div class="w-40 h-40 rounded-3xl overflow-hidden shadow-xl border-4 border-gray-100 relative mb-4">
                    <img id="modalStockImg" src="" class="w-full h-full object-cover">
                    <button onclick="document.getElementById('fileInModal').click()" class="absolute inset-0 bg-black/30 text-white opacity-0 hover:opacity-100 flex items-center justify-center transition-opacity">
                        <i class="fas fa-camera text-2xl"></i>
                    </button>
                    <input type="file" id="fileInModal" class="hidden" onchange="subirImagenModal(event)">
                </div>
                <input type="text" id="modalStockNombre" class="text-center font-black text-xl border-b border-gray-100 uppercase outline-none focus:border-blue-900 w-full" onblur="guardarNombreModelo(this.value)">
            </div>
            <div id="listaColoresStock" class="space-y-3"></div>
            <button onclick="agregarNuevoColor()" class="w-full mt-4 border-2 border-dashed border-gray-200 py-3 rounded-xl text-gray-400 font-bold text-xs uppercase">+ Añadir Color</button>
            <div class="flex gap-2 mt-8">
                <button onclick="eliminarModelo()" class="text-red-400 text-[10px] font-bold uppercase p-2">Eliminar Modelo</button>
                <button onclick="cerrarModalStock()" class="flex-1 bg-blue-900 text-white py-4 rounded-2xl font-black uppercase shadow-lg">Cerrar y Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // DATOS PERSISTENTES (CÓDIGO ORIGINAL + STOCK V6)
        let ventas = JSON.parse(localStorage.getItem('ventas_3d_v3')) || [];
        let gastos = JSON.parse(localStorage.getItem('gastos_3d_v3')) || [];
        let saldoKuboGuardado = localStorage.getItem('saldo_kubo_conciliacion') || 0;
        
        let stockLamparas = JSON.parse(localStorage.getItem('stock_lamparas_v6')) || [
            { id: 1, nombre: 'LÁMPARA EJEMPLO', img: '', colores: { 'BLANCO': 0, 'AQUA': 0 } }
        ];
        
        let stockBases = JSON.parse(localStorage.getItem('stock_bases_3d')) || Array(3).fill().map((_, i) => ({ 
            id: i, nombre: `Base Tipo ${i+1}`, img: '', maderas: [{ nombre: 'Roble', stock: 0 }, { nombre: 'Pino', stock: 0 }, { nombre: 'Negro', stock: 0 }] 
        }));

        let modeloActivoId = null;
        const config = { fil: 20, ene: 100, lla: 200 }; 
        let tempPrecio = 0, tempCostoMat = 0, miChart = null;

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('border-blue-400'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('border-blue-400');
            if(id === 'resumen') { actualizarOpcionesMes(); renderResumen(); }
            if(id === 'stock') renderStock();
            if(id === 'libro') renderLibro();
            if(id === 'gastos') renderGastos();
        }

        // --- SISTEMA DE STOCK V6 (SOLICITADO) ---
        function renderStock() {
            const container = document.getElementById('contenedorLamparas');
            container.innerHTML = '';
            let globalTotal = 0;

            stockLamparas.forEach(mod => {
                let modelTotal = Object.values(mod.colores).reduce((a, b) => a + b, 0);
                globalTotal += modelTotal;
                
                let previewHtml = '';
                Object.keys(mod.colores).slice(0, 4).forEach(c => {
                    previewHtml += `<div class="flex flex-col items-center"><span class="text-[9px] font-black text-blue-900">${mod.colores[c]}</span><span class="text-[6px] text-gray-400 uppercase">${c.substring(0,3)}</span></div>`;
                });

                container.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center" onclick="abrirModalStock(${mod.id})">
                        <div class="img-stock-container"><img src="${mod.img || 'https://via.placeholder.com/150'}"></div>
                        <div class="w-full mt-2 text-center">
                            <p class="font-black text-[10px] uppercase truncate text-gray-700">${mod.nombre}</p>
                            <div class="flex justify-around mt-2 border-t pt-2">${previewHtml}</div>
                        </div>
                    </div>`;
            });
            document.getElementById('totalGlobalStock').innerText = globalTotal;

            // Bases (Grilla Compacta)
            const cb = document.getElementById('contenedorBases');
            cb.innerHTML = '';
            stockBases.forEach(b => {
                cb.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <img src="${b.img || 'https://via.placeholder.com/100'}" class="w-full aspect-square object-cover rounded-xl mb-2" onclick="triggerBaseFile(${b.id})">
                        <input type="file" id="fb-${b.id}" class="hidden" onchange="subirImgBase(event, ${b.id})">
                        <div class="space-y-1">
                            ${b.maderas.map((m, i) => `
                                <div class="flex justify-between items-center text-[8px] bg-gray-50 p-1 rounded font-bold uppercase">
                                    <span>${m.nombre}</span>
                                    <div class="flex items-center gap-1">
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, -1)" class="w-4 h-4 bg-white border rounded shadow-sm text-red-500">-</button>
                                        <span class="w-3 text-center">${m.stock}</span>
                                        <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, 1)" class="w-4 h-4 bg-white border rounded shadow-sm text-green-500">+</button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>`;
            });
        }

        function abrirModalStock(id) {
            modeloActivoId = id;
            const mod = stockLamparas.find(m => m.id === id);
            document.getElementById('modalStockNombre').value = mod.nombre;
            document.getElementById('modalStockImg').src = mod.img || 'https://via.placeholder.com/150';
            renderColoresModal();
            document.getElementById('modalStockDetalle').style.display = 'flex';
        }

        function renderColoresModal() {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            const container = document.getElementById('listaColoresStock');
            container.innerHTML = '';
            let modelTotal = 0;

            Object.keys(mod.colores).forEach(color => {
                modelTotal += mod.colores[color];
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <span class="text-xs font-black text-blue-900 uppercase tracking-widest">${color}</span>
                        <div class="flex items-center gap-4">
                            <button onclick="cambiarStockColor('${color}', -1)" class="w-10 h-10 bg-white shadow-sm rounded-full font-black text-red-500">-</button>
                            <span class="text-lg font-black w-8 text-center">${mod.colores[color]}</span>
                            <button onclick="cambiarStockColor('${color}', 1)" class="w-10 h-10 bg-blue-900 text-white shadow-md rounded-full font-black">+</button>
                            <button onclick="borrarColor('${color}')" class="text-gray-300 ml-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            document.getElementById('modalTotalUnidades').innerText = `${modelTotal} UNIDADES`;
        }

        function cambiarStockColor(color, delta) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.colores[color] = Math.max(0, mod.colores[color] + delta);
            saveStock(); renderColoresModal();
        }

        function agregarNuevoColor() {
            const nombre = prompt("Nombre del nuevo color (ej: AQUA, COBRE):");
            if(nombre) {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                const upper = nombre.toUpperCase();
                if(!mod.colores[upper]) mod.colores[upper] = 0;
                saveStock(); renderColoresModal();
            }
        }

        function subirImagenModal(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                stockLamparas.find(m => m.id === modeloActivoId).img = ev.target.result;
                document.getElementById('modalStockImg').src = ev.target.result;
                saveStock();
            };
            r.readAsDataURL(f);
        }

        function guardarNombreModelo(v) { stockLamparas.find(m => m.id === modeloActivoId).nombre = v.toUpperCase(); saveStock(); }
        function nuevoModelo() { const id = Date.now(); stockLamparas.push({ id, nombre: 'NUEVA LÁMPARA', img: '', colores: { 'BLANCO': 0 } }); saveStock(); renderStock(); abrirModalStock(id); }
        function eliminarModelo() { if(confirm('¿BORRAR MODELO?')) { stockLamparas = stockLamparas.filter(m => m.id !== modeloActivoId); saveStock(); cerrarModalStock(); } }
        function borrarColor(c) { if(confirm('¿Borrar color?')) { delete stockLamparas.find(m => m.id === modeloActivoId).colores[c]; saveStock(); renderColoresModal(); } }
        function cerrarModalStock() { document.getElementById('modalStockDetalle').style.display = 'none'; renderStock(); }
        function saveStock() { localStorage.setItem('stock_lamparas_v6', JSON.stringify(stockLamparas)); }

        // Lógica de Bases (UX Compacta)
        function chStBase(bid, mid, d) { stockBases.find(x => x.id === bid).maderas[mid].stock = Math.max(0, stockBases.find(x => x.id === bid).maderas[mid].stock + d); localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases)); renderStock(); }
        function triggerBaseFile(id) { document.getElementById(`fb-${id}`).click(); }
        function subirImgBase(e, id) { const r = new FileReader(); r.onload = (ev) => { stockBases.find(x => x.id === id).img = ev.target.result; localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases)); renderStock(); }; r.readAsDataURL(e.target.files[0]); }

        // --- LÓGICA DE COTIZADOR, VENTAS Y RESUMEN (CÓDIGO ORIGINAL SIN CAMBIOS) ---
        function toggleLlavero() { document.getElementById('boxLlavero').classList.toggle('hidden', !document.getElementById('checkLlavero').checked); calcular(); }

        function calcular() {
            const f = parseFloat(document.getElementById('filamento').value) || 0;
            const e = parseFloat(document.getElementById('energia').value) || 0;
            const l = document.getElementById('checkLlavero').checked ? (parseFloat(document.getElementById('cantLlaveros').value) || 0) : 0;
            const m = parseFloat(document.getElementById('manoObra').value) || 0;
            tempCostoMat = (f * config.fil) + (e * config.ene) + (l * config.lla);
            tempPrecio = Math.round(((f * config.fil + e * config.ene) * 3.5) + (l * config.lla) + (m * 10000)); 
            document.getElementById('costoRealRef').innerText = `$${tempCostoMat.toLocaleString()}`;
            document.getElementById('precioFinalDisplay').innerText = `$${tempPrecio.toLocaleString()}`;
            document.getElementById('displayNombre').innerText = document.getElementById('nombreTrabajo').value || "Proyecto Personalizado";
        }

        function abrirModalGuardar() { document.getElementById('modalGuardar').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalGuardar').classList.add('hidden'); }

        function guardarDesdeCotizador() {
            const item = { id: Date.now(), fecha: new Date().toISOString().split('T')[0], cliente: document.getElementById('modalCliente').value || "S/N", trabajo: document.getElementById('nombreTrabajo').value || "Impresión 3D", precio: tempPrecio, costo: tempCostoMat, categoria: document.getElementById('modalCategoria').value };
            ventas.push(item); save(); cerrarModal(); alert("Venta registrada");
        }

        function agregarVentaManual() {
            const v = { id: Date.now(), fecha: document.getElementById('ventaFecha').value || new Date().toISOString().split('T')[0], cliente: document.getElementById('ventaCliente').value || "Manual", trabajo: "Carga manual", precio: parseFloat(document.getElementById('ventaPrecio').value) || 0, costo: parseFloat(document.getElementById('ventaCosto').value) || 0, categoria: document.getElementById('ventaCategoria').value };
            ventas.push(v); save(); renderLibro();
        }

        function agregarGasto() {
            const g = { id: Date.now(), fecha: document.getElementById('gastoFecha').value || new Date().toISOString().split('T')[0], motivo: document.getElementById('gastoMotivo').value || "Insumo", monto: parseFloat(document.getElementById('gastoMonto').value) || 0 };
            gastos.push(g); save(); renderGastos();
        }

        function renderLibro() {
            const container = document.getElementById('listaVentasPorMes'); container.innerHTML = '';
            const grupos = ventas.reduce((acc, v) => { const mes = v.fecha.substring(0, 7); if(!acc[mes]) acc[mes] = []; acc[mes].push(v); return acc; }, {});
            Object.keys(grupos).sort().reverse().forEach(mes => {
                let html = `<div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6"><div class="bg-gray-800 text-white px-4 py-2 text-xs font-bold uppercase tracking-widest">${mes}</div><table class="w-full text-left"><tbody class="divide-y divide-gray-100">`;
                grupos[mes].forEach(v => { html += `<tr class="p-3"><td class="p-3"><div class="font-bold">${v.cliente}</div><div class="text-[10px] text-gray-400">${v.trabajo}</div></td><td class="p-3 text-right"><div class="text-blue-600 font-bold">$${v.precio.toLocaleString()}</div><div class="text-[10px] text-green-500">+$${(v.precio - v.costo).toLocaleString()}</div></td><td class="p-3 text-center"><button onclick="borrarVenta(${v.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>`; });
                container.innerHTML += html + `</tbody></table></div>`;
            });
        }

        function renderGastos() {
            const div = document.getElementById('listaGastosItems'); div.innerHTML = '';
            gastos.slice().reverse().forEach(g => { div.innerHTML += `<div class="p-4 flex justify-between items-center bg-white"><div><div class="font-bold text-gray-700">${g.motivo}</div><div class="text-[10px] text-gray-400">${g.fecha}</div></div><div class="flex items-center gap-4"><span class="text-red-500 font-bold">-$${g.monto.toLocaleString()}</span><button onclick="borrarGasto(${g.id})" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></button></div></div>`; });
        }

        function actualizarOpcionesMes() {
            const sel = document.getElementById('filtroMes');
            const valorActual = sel.value;
            sel.innerHTML = '<option value="all">HISTÓRICO COMPLETO</option>';
            const meses = [...new Set([...ventas.map(v => v.fecha.substring(0,7)), ...gastos.map(g => g.fecha.substring(0,7))])].sort().reverse();
            meses.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            sel.value = valorActual;
        }

        function renderResumen() {
            const f = document.getElementById('filtroMes').value;
            const vF = f === 'all' ? ventas : ventas.filter(v => v.fecha.startsWith(f));
            const gF = f === 'all' ? gastos : gastos.filter(g => g.fecha.startsWith(f));
            const totalVentas = vF.reduce((s,v) => s + v.precio, 0);
            const totalCostoProd = vF.reduce((s,v) => s + v.costo, 0);
            const gananciaBruta = totalVentas - totalCostoProd;
            const totalInsumos = gF.reduce((s,g) => s + g.monto, 0);

            document.getElementById('kpiVentas').innerText = `$${totalVentas.toLocaleString()}`;
            document.getElementById('kpiRentabilidad').innerText = totalVentas > 0 ? Math.round((gananciaBruta / totalVentas) * 100) + "%" : "0%";
            document.getElementById('kpiTicket').innerText = vF.length > 0 ? `$${Math.round(totalVentas / vF.length).toLocaleString()}` : "$0";
            document.getElementById('kpiGananciaProm').innerText = vF.length > 0 ? `$${Math.round(gananciaBruta / vF.length).toLocaleString()}` : "$0";
            document.getElementById('detIngresos').innerText = `$${totalVentas.toLocaleString()}`;
            document.getElementById('detCostosProd').innerText = `-$${totalCostoProd.toLocaleString()}`;
            document.getElementById('detNeto').innerText = `$${gananciaBruta.toLocaleString()}`;
            document.getElementById('detGastosIns').innerText = `$${totalInsumos.toLocaleString()}`;

            const totalHistV = ventas.reduce((s,v) => s + v.precio, 0);
            const totalHistE = ventas.reduce((s,v) => s + v.costo, 0) + gastos.reduce((s,g) => s + g.monto, 0);
            const balanceRealTeorico = totalHistV - totalHistE;
            document.getElementById('balanceTotal').innerText = `$${balanceRealTeorico.toLocaleString()}`;
            document.getElementById('saldoKubo').value = saldoKuboGuardado;
            conciliarCaja();

            const ctx = document.getElementById('canvasGrafico').getContext('2d');
            if(miChart) miChart.destroy();
            if(document.getElementById('tipoGrafico').value === 'torta') {
                const cats = vF.reduce((acc, v) => { acc[v.categoria] = (acc[v.categoria] || 0) + (v.precio - v.costo); return acc; }, {});
                miChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#1e3a8a', '#10b981', '#f59e0b'] }] }, options: { plugins: { legend: { position: 'bottom' }}}});
            } else {
                miChart = new Chart(ctx, { type: 'bar', data: { labels: ['Ingresos', 'Costos Mat.', 'Insumos'], datasets: [{ label: 'Finanzas', data: [totalVentas, totalCostoProd, totalInsumos], backgroundColor: ['#1e3a8a', '#f97316', '#ef4444'] }] }});
            }
        }

        function conciliarCaja() {
            const teoricoStr = document.getElementById('balanceTotal').innerText.replace('$','').replace(/\./g,'');
            const teorico = parseFloat(teoricoStr) || 0;
            const kubo = parseFloat(document.getElementById('saldoKubo').value) || 0;
            const diff = kubo - teorico;
            const el = document.getElementById('diffKubo');
            el.innerText = `Dif: ${diff >= 0 ? '+' : ''}$${diff.toLocaleString()}`;
            el.className = `text-[10px] mt-1 font-bold ${diff === 0 ? 'text-green-400' : 'text-red-400'}`;
            localStorage.setItem('saldo_kubo_conciliacion', kubo);
            saldoKuboGuardado = kubo;
        }

        function save() { localStorage.setItem('ventas_3d_v3', JSON.stringify(ventas)); localStorage.setItem('gastos_3d_v3', JSON.stringify(gastos)); }
        function borrarVenta(id) { if(confirm('¿Borrar?')) { ventas = ventas.filter(v => v.id !== id); save(); renderLibro(); } }
        function borrarGasto(id) { if(confirm('¿Borrar?')) { gastos = gastos.filter(g => g.id !== id); save(); renderGastos(); } }
        function exportarExcel() {
            const data = ventas.map(v => ({ Fecha: v.fecha, Cliente: v.cliente, Detalle: v.trabajo, Categoria: v.categoria, Ingreso: v.precio, Costo_Material: v.costo, Ganancia_Bruta: v.precio - v.costo }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ventas"); XLSX.writeFile(wb, "Gestion_3D_Backup.xlsx");
        }

        // Init
        document.getElementById('ventaFecha').valueAsDate = new Date();
        document.getElementById('gastoFecha').valueAsDate = new Date();
        renderLibro(); renderGastos(); renderResumen(); renderStock();
    </script>
</body>
</html>
