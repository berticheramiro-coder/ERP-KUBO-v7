<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión 3D Pro - V6 Estable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .ticket-cliente { background: #ffffff; border: 1px solid #e2e8f0; border-top: 8px solid #1e3a8a; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .kpi-card { background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; }
        
        /* --- NUEVA UX STOCK --- */
        .grid-stock { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 768px) { .grid-stock { grid-template-columns: repeat(4, 1fr); } }
        
        .img-container { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; background: #e2e8f0; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        
        .badge-total { position: absolute; top: 5px; right: 5px; background: rgba(30, 58, 138, 0.9); color: white; font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        
        .color-preview-dots { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; min-height: 15px; }
        .dot { font-size: 9px; font-weight: 800; background: #f1f5f9; padding: 1px 4px; border-radius: 4px; color: #475569; border: 1px solid #e2e8f0; }

        .modal-stock { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
        .modal-stock-content { background: white; width: 100%; max-height: 85vh; overflow-y: auto; border-radius: 24px 24px 0 0; padding: 20px; }
        @media (min-width: 768px) { .modal-stock { align-items: center; } .modal-stock-content { max-width: 400px; border-radius: 24px; } }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center px-2">
            <h1 class="text-xl font-bold"><i class="fas fa-microchip"></i> Gestión 3D</h1>
            <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs py-1 px-3 rounded flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Exportar
            </button>
        </div>
        <div class="container mx-auto flex justify-around mt-4 text-[10px] md:text-xs font-bold uppercase tracking-wider">
            <button onclick="switchTab('cotizador')" class="tab-btn pb-2 border-b-2 border-blue-400" id="btn-cotizador">Cotizar</button>
            <button onclick="switchTab('libro')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-libro">Ventas</button>
            <button onclick="switchTab('gastos')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-gastos">Insumos</button>
            <button onclick="switchTab('resumen')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-resumen">Finanzas</button>
            <button onclick="switchTab('stock')" class="tab-btn pb-2 border-b-2 border-transparent" id="btn-stock">Stock</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">
        <div id="cotizador" class="tab-content active max-w-xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100">
                <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-gray-800 uppercase text-sm tracking-widest">Calculadora Interna</h2><div class="bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-100">Costo Mat: <span id="costoRealRef">$0</span></div></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Nombre del Trabajo</label><input type="text" id="nombreTrabajo" class="w-full border p-2 rounded bg-gray-50" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Filamento (gr)</label><input type="number" id="filamento" class="w-full border p-2 rounded" oninput="calcular()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Energía (horas)</label><input type="number" id="energia" class="w-full border p-2 rounded" oninput="calcular()"></div>
                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="checkLlavero" class="w-5 h-5 rounded" onchange="toggleLlavero()"><label class="text-xs font-bold text-gray-700">¿Llavero?</label></div>
                    <div id="boxLlavero" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">Cant. Llaveros</label><input type="number" id="cantLlaveros" class="w-full border p-2 rounded" value="0" oninput="calcular()"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Mano de Obra (horas)</label><input type="number" id="manoObra" class="w-full border p-2 rounded" oninput="calcular()"></div>
                </div>
            </div>
            <div class="ticket-cliente p-8 text-center"><h3 id="displayNombre" class="text-xl font-bold mb-2">Proyecto</h3><div class="text-5xl font-black mb-2" id="precioFinalDisplay">$0</div></div>
            <button onclick="abrirModalGuardar()" class="w-full mt-6 bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg">REGISTRAR VENTA</button>
        </div>

        <div id="libro" class="tab-content max-w-xl mx-auto"><div id="listaVentasPorMes"></div></div>
        <div id="gastos" class="tab-content max-w-xl mx-auto"><div id="listaGastosItems"></div></div>
        <div id="resumen" class="tab-content max-w-xl mx-auto">
            <div class="bg-black text-white p-5 rounded-2xl mb-6 flex justify-between">
                <div><div class="text-[10px] text-gray-400">Balance Teórico</div><div id="balanceTotal" class="text-3xl font-black text-green-400">$0</div></div>
                <div class="text-right"><input type="number" id="saldoKubo" class="bg-white/10 p-1 text-right w-24" oninput="conciliarCaja()"><div id="diffKubo" class="text-[10px]"></div></div>
            </div>
            <canvas id="canvasGrafico"></canvas>
        </div>

        <div id="stock" class="tab-content">
            <div class="bg-white p-4 rounded-2xl mb-6 shadow-sm border flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Stock Total Lámparas</p>
                    <p id="granTotalStock" class="text-3xl font-black text-blue-900">0</p>
                </div>
                <button onclick="nuevoModelo()" class="bg-blue-900 text-white px-4 py-2 rounded-xl text-xs font-bold">+ NUEVO MODELO</button>
            </div>

            <h2 class="text-sm font-black text-gray-800 mb-4 uppercase"><i class="fas fa-lightbulb text-yellow-500"></i> Modelos</h2>
            <div class="grid-stock mb-10" id="contenedorLamparas"></div>
            
            <h2 class="text-sm font-black text-gray-800 mb-4 uppercase"><i class="fas fa-layer-group text-blue-500"></i> Bases y Maderas</h2>
            <div class="grid-stock" id="contenedorBases"></div>
        </div>
    </div>

    <div id="modalStockDetalle" class="modal-stock">
        <div class="modal-stock-content shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <span id="modalTotalMod" class="bg-blue-900 text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase">0 Unidades</span>
                <button onclick="cerrarModalStock()" class="text-gray-400 text-2xl"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 h-32 rounded-2xl overflow-hidden border-4 border-gray-100 shadow-lg relative bg-gray-50">
                    <img id="modalImg" class="w-full h-full object-cover">
                    <input type="file" id="fileInModal" class="hidden" onchange="procesarFoto(event)">
                    <button onclick="document.getElementById('fileInModal').click()" class="absolute inset-0 bg-black/20 text-white flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity"><i class="fas fa-camera"></i></button>
                </div>
                <input type="text" id="modalNombre" class="mt-4 text-center font-black text-xl w-full border-b outline-none uppercase" onblur="guardarNombre(this.value)">
            </div>
            
            <div id="listaColores" class="space-y-2"></div>
            
            <button onclick="agregarColor()" class="w-full mt-4 py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 text-xs font-bold uppercase">+ Agregar Color</button>
            <button onclick="eliminarModelo()" class="w-full mt-8 text-red-400 text-[10px] font-bold uppercase">Eliminar Modelo</button>
        </div>
    </div>

    <div id="modalGuardar" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
            <h3 class="font-bold mb-4">Finalizar Venta</h3>
            <input type="text" id="modalCliente" placeholder="Cliente" class="w-full border p-3 rounded-xl mb-4">
            <button onclick="guardarDesdeCotizador()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold">CONFIRMAR</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let ventas = JSON.parse(localStorage.getItem('ventas_3d_v3')) || [];
        let gastos = JSON.parse(localStorage.getItem('gastos_3d_v3')) || [];
        let stockLamparas = JSON.parse(localStorage.getItem('stock_v6_lamparas')) || [
            { id: 1, nombre: 'Modelo Base', img: '', colores: { 'BLANCO': 0 } }
        ];
        let stockBases = JSON.parse(localStorage.getItem('stock_bases_3d')) || Array(3).fill().map((_, i) => ({ 
            id: i, nombre: `Base ${i+1}`, img: '', maderas: [{ nombre: 'Roble', stock: 0 }, { nombre: 'Negro', stock: 0 }] 
        }));

        let modeloActivoId = null;

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('border-blue-400'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('border-blue-400');
            if(id === 'stock') renderStock();
            if(id === 'resumen') renderResumen();
        }

        // --- LÓGICA DE STOCK V6 ---
        function renderStock() {
            const cl = document.getElementById('contenedorLamparas');
            cl.innerHTML = '';
            let granTotal = 0;

            stockLamparas.forEach(m => {
                let totalMod = Object.values(m.colores).reduce((a, b) => a + b, 0);
                granTotal += totalMod;

                // Generar preview solo de colores con stock > 0
                let dots = '';
                Object.keys(m.colores).forEach(c => {
                    if(m.colores[c] > 0) dots += `<span class="dot">${m.colores[c]} ${c.substring(0,3)}</span>`;
                });

                cl.innerHTML += `
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-gray-100" onclick="abrirModalStock(${m.id})">
                        <div class="img-container">
                            <img src="${m.img || 'https://via.placeholder.com/150'}">
                            <div class="badge-total">${totalMod}</div>
                        </div>
                        <p class="text-[10px] font-black uppercase mt-2 truncate text-gray-800">${m.nombre}</p>
                        <div class="color-preview-dots">${dots}</div>
                    </div>`;
            });

            document.getElementById('granTotalStock').innerText = granTotal;

            // Render Bases (UX Compacta)
            const cb = document.getElementById('contenedorBases');
            cb.innerHTML = '';
            stockBases.forEach(b => {
                cb.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl shadow-sm border flex gap-3">
                        <img src="${b.img || 'https://via.placeholder.com/80'}" class="w-16 h-16 object-cover rounded-xl" onclick="triggerBaseFile(${b.id})">
                        <input type="file" id="fb-${b.id}" class="hidden" onchange="procesarFotoBase(event, ${b.id})">
                        <div class="flex-1">
                            <p class="text-[10px] font-bold uppercase text-blue-900">${b.nombre}</p>
                            <div class="flex gap-2 mt-2">
                                ${b.maderas.map((m, i) => `
                                    <div class="flex-1 bg-gray-50 p-1 rounded text-center">
                                        <p class="text-[8px] font-bold text-gray-400 uppercase">${m.nombre}</p>
                                        <div class="flex justify-between items-center px-1">
                                            <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, -1)" class="text-red-500 font-bold">-</button>
                                            <span class="text-[10px] font-black">${m.stock}</span>
                                            <button onclick="event.stopPropagation(); chStBase(${b.id}, ${i}, 1)" class="text-green-500 font-bold">+</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            });
        }

        // --- MANEJO DE FOTOS (ACHICADO PARA QUE NO SE TRABE) ---
        function procesarFoto(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const size = 400; // Tamaño suficiente para buena calidad pero muy liviano
                    canvas.width = size; canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, size, size);
                    const compressed = canvas.toDataURL('image/jpeg', 0.7);
                    stockLamparas.find(m => m.id === modeloActivoId).img = compressed;
                    document.getElementById('modalImg').src = compressed;
                    saveStock();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- POPUP GESTIÓN ---
        function abrirModalStock(id) {
            modeloActivoId = id;
            const mod = stockLamparas.find(m => m.id === id);
            document.getElementById('modalNombre').value = mod.nombre;
            document.getElementById('modalImg').src = mod.img || 'https://via.placeholder.com/150';
            renderColoresPopup();
            document.getElementById('modalStockDetalle').style.display = 'flex';
        }

        function renderColoresPopup() {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            const container = document.getElementById('listaColores');
            container.innerHTML = '';
            let total = 0;

            Object.keys(mod.colores).forEach(c => {
                total += mod.colores[c];
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl">
                        <span class="text-xs font-black uppercase text-gray-600">${c}</span>
                        <div class="flex items-center gap-4">
                            <button onclick="chColor('${c}', -1)" class="w-10 h-10 bg-white shadow rounded-full text-red-500 font-black">-</button>
                            <span class="w-6 text-center font-black">${mod.colores[c]}</span>
                            <button onclick="chColor('${c}', 1)" class="w-10 h-10 bg-blue-900 text-white shadow rounded-full font-black">+</button>
                        </div>
                    </div>`;
            });
            document.getElementById('modalTotalMod').innerText = `${total} UNIDADES`;
        }

        function chColor(c, d) {
            const mod = stockLamparas.find(m => m.id === modeloActivoId);
            mod.colores[c] = Math.max(0, mod.colores[c] + d);
            saveStock(); renderColoresPopup();
        }

        function agregarColor() {
            const n = prompt("Nombre del color: (AQUA, ROJO, etc)").toUpperCase();
            if(n) {
                const mod = stockLamparas.find(m => m.id === modeloActivoId);
                if(!mod.colores[n]) mod.colores[n] = 0;
                saveStock(); renderColoresPopup();
            }
        }

        function guardarNombre(v) { stockLamparas.find(m => m.id === modeloActivoId).nombre = v.toUpperCase(); saveStock(); }
        function nuevoModelo() { const id = Date.now(); stockLamparas.push({ id, nombre: 'NUEVO MODELO', img: '', colores: { 'BLANCO': 0 } }); saveStock(); renderStock(); abrirModalStock(id); }
        function eliminarModelo() { if(confirm('¿ELIMINAR MODELO?')) { stockLamparas = stockLamparas.filter(m => m.id !== modeloActivoId); saveStock(); cerrarModalStock(); } }
        function cerrarModalStock() { document.getElementById('modalStockDetalle').style.display = 'none'; renderStock(); }
        function saveStock() { localStorage.setItem('stock_v6_lamparas', JSON.stringify(stockLamparas)); }

        // Lógica de Bases (UX Compacta)
        function chStBase(bid, mid, d) { stockBases.find(x => x.id === bid).maderas[mid].stock = Math.max(0, stockBases.find(x => x.id === bid).maderas[mid].stock + d); localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases)); renderStock(); }
        function triggerBaseFile(id) { document.getElementById(`fb-${id}`).click(); }
        function procesarFotoBase(e, id) { 
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => { stockBases.find(x => x.id === id).img = ev.target.result; localStorage.setItem('stock_bases_3d', JSON.stringify(stockBases)); renderStock(); };
            r.readAsDataURL(f);
        }

        // --- LÓGICA COTIZADOR Y FINANZAS (ORIGINAL) ---
        const config = { fil: 20, ene: 100, lla: 200 };
        let tempPrecio = 0, tempCostoMat = 0, miChart = null;
        function toggleLlavero() { document.getElementById('boxLlavero').classList.toggle('hidden', !document.getElementById('checkLlavero').checked); }
        function calcular() {
            const f = parseFloat(document.getElementById('filamento').value) || 0;
            const e = parseFloat(document.getElementById('energia').value) || 0;
            const l = document.getElementById('checkLlavero').checked ? (parseFloat(document.getElementById('cantLlaveros').value) || 0) : 0;
            const m = parseFloat(document.getElementById('manoObra').value) || 0;
            tempCostoMat = (f * config.fil) + (e * config.ene) + (l * config.lla);
            tempPrecio = Math.round(((f * config.fil + e * config.ene) * 3.5) + (l * config.lla) + (m * 10000));
            document.getElementById('costoRealRef').innerText = `$${tempCostoMat.toLocaleString()}`;
            document.getElementById('precioFinalDisplay').innerText = `$${tempPrecio.toLocaleString()}`;
        }
        function abrirModalGuardar() { document.getElementById('modalGuardar').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalGuardar').classList.add('hidden'); }
        function guardarDesdeCotizador() {
            ventas.push({ id: Date.now(), fecha: new Date().toISOString().split('T')[0], cliente: document.getElementById('modalCliente').value || "S/N", trabajo: document.getElementById('nombreTrabajo').value || "Imp 3D", precio: tempPrecio, costo: tempCostoMat, categoria: 'Lámparas' });
            localStorage.setItem('ventas_3d_v3', JSON.stringify(ventas));
            cerrarModal(); alert("Venta registrada");
        }

        function renderResumen() {
            const totalV = ventas.reduce((s,v) => s + v.precio, 0);
            const totalG = gastos.reduce((s,g) => s + g.monto, 0);
            document.getElementById('balanceTotal').innerText = `$${(totalV - totalG).toLocaleString()}`;
        }

        // INIT
        renderStock(); renderResumen();
    </script>
</body>
</html>
